<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="platform">

    <xacro:macro name="wheel" params="parent name side_name rpy xyz axis effort velocity friction damping" >

        <!-- LINK -->
        <xacro:macro name="wheel_geo">
            <origin rpy="1.57075 0 0" xyz="0 0 0"/>
            <geometry>
                <cylinder length="0.15" radius="0.1"/>
            </geometry>
        </xacro:macro>

        <xacro:macro name="wheel_mesh">
            <xacro:if value="${side_name == 'l'}">   <origin rpy="0 0 0.0000" xyz="0 0 0"/>   </xacro:if>
            <xacro:if value="${side_name == 'r'}">   <origin rpy="0 0 0.0000" xyz="0 0 0"/>   </xacro:if>
            <geometry>
                <mesh filename="package://kalman_description/meshes/203_wheel.STL" scale="0.001 0.001 0.001"/>
            </geometry>
        </xacro:macro>

        <xacro:macro name="wheel_color">
            <material name="light_gray">
                <color rgba=".7 .3 .4 1"/>
            </material>
        </xacro:macro>

        <link name="${name}">
            <visual>
                <xacro:wheel_mesh/>    
                <xacro:wheel_color/>
            </visual>

            <collision>
                <xacro:wheel_geo/>
            </collision>

            <xacro:cylinder_inertial radius="0.1" length="0.15" mass="3.3">
                <origin rpy="1.57075 0 0" xyz="0 0 0"/>
            </xacro:cylinder_inertial>

        </link>
        <gazebo reference="${name}">
            <mu1> 1 </mu1>
            <mu2> 1 </mu2>
            <kp> 1160000 </kp>
            <kd> 1000 </kd>
            <material> Gazebo/Orange </material>
            <selfCollide>False</selfCollide>
        </gazebo>

        <!-- JOINT -->
        <joint name="${name}_joint" type="continuous">
            <parent link="${parent}"/>
            <child link="${name}"/>
            <origin rpy="${rpy}" xyz="${xyz}"/>
            <axis xyz="${axis}"/>
            <limit effort="${effort}" velocity="${velocity}"/>
            <dynamics friction="${friction}" damping="${damping}"/>
        </joint>
        <gazebo reference="${name}_joint">
            <stopCfm>0.8</stopCfm>
            <stopErp>0.1</stopErp>
            <provideFeedback>true</provideFeedback>
            <implicitSpringDamper>true</implicitSpringDamper>
            <fudgeFactor>0.0</fudgeFactor>
        </gazebo>

        <!-- MOTOR -->
        <transmission name="${name}_transmission">
            <type>transmission_interface/SimpleTransmission</type>
            <joint name="${name}_joint">
                <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            </joint>
            <actuator name="${name}_motor">
                <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
                <mechanicalReduction>1</mechanicalReduction>
            </actuator>
        </transmission>

        <!-- ENCODER -->
        <gazebo>
            <plugin name="${name}_encoder" filename="libJointEncoder.so">
                <joint>${name}_joint</joint>
                <topic>/kalman/simulation/encoder/${name}_rel</topic>
                <absolute>0</absolute>
                <resolution>3600</resolution>
            </plugin>
        </gazebo>

    </xacro:macro>
</robot>
